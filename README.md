# ApproveJ Workshop

Workshop material for learning ApproveJ.org.


## Material

In order to fulfill the following objectives, you will need

- The contents of this repository,
- JDK 21 installed on your system, and
- an IDE like IntelliJ IDEA


## Objectives

### Setup

- [ ] Checkout the code of this repository and load it in your IDE.

- [ ] Try to run all tests using Gradle on the command line

  ```bash
  ./gradlew check
  ```

- [ ] Execute a simple application unit test class like [ArticleImporterTest](src/test/kotlin/org/approvej/workshop/service/application/article/ArticleImporterTest.kt) via you IDE.

- [ ] Execute an adapter integration tests like [ShoppingCartControllerApiTest](src/test/kotlin/org/approvej/workshop/service/adapters/demanding/restapi/shoppingcart/ShoppingCartControllerApiTest.kt).


### Approving vs Asserting String Results

Approval testing is particularly useful for tests with a lot of assertions on a single result objects.
As approving the result as whole, in contrast to asserting single aspects of it, makes the test less bloated, confusing and concise.

For the following objectives, you will need knowledge from the ApproveJ manual chapter [Approve Strings](https://approvej.org/#approve_strings).

- [ ] Take a look at the [ArticleControllerTest](src/test/kotlin/org/approvej/workshop/service/adapters/demanding/restapi/article/ArticleControllerTest.kt).

  The test contains a lot of assertions that specify the result body in quite some detail.

- [ ] Replace all assertions on the response body with a single approval.

  ```kotlin
  approve(response.body()).byFile()
  ```

  The test should fail and open a diff view of the new received file `ArticleControllerTest-get_articles-received.txt` and the new and empty approved file `ArticleControllerTest-get_articles-approved.txt` right next to the test file.

  You can approve the received body by putting the content of the received file into the approved file using the diff view's `>>` button.

- [ ] Re-run the test.

  This time it should be successful and the received file should automatically be removed.


### Pretty Printing

Now the content of the approved file is not exactly great to read.
A change in the content of the last returned article might easily be overlooked.
Even though the content is in proper JSON format, the IDE honors the filename extension `txt` and does not apply proper syntax highlighting.

Let's change that by applying proper [printing](https://approvej.org/#printing) and the [JSON pretty printing](https://approvej.org/#_pretty_print_json_strings) abilities of ApproveJ's JSON module.

- [ ] Apply the `JsonStringPrettyPrinter` to the result using the `printedWith` method.

  ```kotlin
  approve(response.body())
    .printWith(jsonStringPrettyPrinter())
    .byFile()
  ```

  This time the diff view opens for two new files: `ArticleControllerTest-get_articles-received.json` and `ArticleControllerTest-get_articles-approved.json`.
  Note that applying the printer changed the filename extension automatically.
  The old `txt` files can be removed.

- [ ] Approve the received and rerun the test.
  It should succeed now.

- [ ] Compare the approved file's content with the original assertions.
  Were there any oversights?


### Scrubbing Dynamic Data from Results

Note that so far the results must be very static.
The test arranges the test data in a way, that the result contains no dynamic value.
E.g. the IDs of the articles are not random, bet are always set to the same static values.
This may not always be possible.
Parts of the data may be generated by the code.
That could be IDs of any kind, timestamps, dates etc.

To deal with such problems, ApproveJ comes with a feature called [Scrubbing](https://approvej.org/#scrubbing).

- [ ] Take a look at the [ShoppingCartControllerApiTest](src/test/kotlin/org/approvej/workshop/service/adapters/demanding/restapi/shoppingcart/ShoppingCartControllerTest.kt).

  Again, try to replace the assertions on the first test case with `approval(response.body()).printWith(jsonStringPrettyPrinter()).byFile()`.

- [ ] Approve the results and re-run the test.

  It still fails, as the ID of the shopping cart is generated by the business logic, and we have no way of controlling it from the test code.

- [ ] Add `scrubbedOf(uuids())` to replace the dynamic UUID with a placeholder.
  Re-run the test and approve the result.

- [ ] Try to replace the other test cases' assertions with the same approval.

- [ ] Figure out why the tests fail and chose one of the [Scrubbers](https://approvej.org/javadoc/core/org/approvej/scrub/Scrubbers.html) to deal with the remaining dynamic values.

- [ ] Again, compare the approved file with the original assertions.


### Approving & Scrubbing POJO Results

So far, we only looked at API tests whose results are basically strings.
But ApproveJ also allows to [approve any kind of plain old Java object (POJO)](https://approvej.org/#approve_pojos).

- [ ] The [ArticleDtoTest](src/test/kotlin/org/approvej/workshop/service/adapters/demanding/restapi/article/ArticleDtoTest.kt) checks the mapping between the `Article` and the `ArticleDto` class.
  Again, this takes quite a lot of assertions.
  Try to replace it with an approval.

- [ ] The received file again contains the result object in a single line, which makes it hard to overlook differences.

  ApproveJ offers a variate of Printers to turn POJOs into readable strings.
  The most basic one would be the [`ObjectPrinter`](https://approvej.org/javadoc/core/org/approvej/print/ObjectPrinter.html), but you can also choose the [`JsonPrettyPrinter`](https://approvej.org/javadoc/json-jackson/org/approvej/json/jackson/JsonPrettyPrinter.html), or the [`YamlPrinter`](https://approvej.org/javadoc/yaml-jackson/org/approvej/yaml/jackson/YamlPrinter.html), or use a custom implementation of the `Printer` interface.

  Choose one option and re-run the test.

- [ ] Again, we are faced with some dynamic values in the result that keep the test from succeeding.

  The `uuids()` scrubber reduces the problem, but won't suffice this time.
  Maybe the [`stringsMatching(pattern)`](https://approvej.org/javadoc/core/org/approvej/scrub/Scrubbers.html#stringsMatching(java.lang.String)) could be used, or the [`strings(stringâ€¦)`](https://approvej.org/javadoc/core/org/approvej/scrub/Scrubbers.html#strings(java.lang.String,java.lang.String...)) could also be an option, or you could write your very own custom [`Scrubber<ArticelDto>`](https://approvej.org/#_custom_scrubber)?

  Maybe you can also find a way to avoid scrubbing at all?

- [ ] Apply the same to the [ItemDtoTest](src/test/kotlin/org/approvej/workshop/service/adapters/demanding/restapi/shoppingcart/ItemDtoTest.kt).

  Here, you won't be able to avoid applying one of the [Scrubbers](https://approvej.org/javadoc/core/org/approvej/scrub/Scrubbers.html).
